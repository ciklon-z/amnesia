For [[!taglink release/1.0]], we decided we want basic Tor stream isolation.

[[!toc levels=2]]

Roadmap
=======

[[!tag todo/code]]

We can start implementing and testing while we [[!taglink todo/wait]]
for:

* [[todo/Tor 0.2.3]] to go into devel
* reviews of the following design (asked on tor-talk@ and tails-dev@
  on 2012-08-25: <854nnoy67k.fsf@boum.org>)

Hopefully we get the whole thing in Tails 0.14 or 0.15.

Implementation started in `feature/separate_Tor_streams`, left to do:

* have Claws Mails use the SocksPort dedicated for the MUA
  (127.0.1.0:9061),
  `config/chroot_local-includes/usr/local/bin/torified-claws-mail`
* have the Tails-specific applications use the SocksPort dedicated for
  Tails-specific applications (127.0.1.0:9062)
  - Tails IUK update check (in `lib/Tails/IUK/TargetFile/Download.pm`
    and `lib/Tails/IUK/UpdateDescriptionFile/Download.pm`)
  - WhisperBack (currently uses torsocks, so would need uwt or
    similar, but given no other application than WB, hopefully, will
    be talking to the hidden service used to relay WB's email, we
    don't care that much isolating that one.)
  - htpdate (Would using torsocks to run wget bypass the wgetrc HTTP
    proxy settings? Or should we convert it to curl?)
  - more?

Design
======

Tails-specific applications
---------------------------

Tails-specific applications such as incremental updates and htpdate
should use a dedicated `SocksPort`, so that they don't help trivial
correlating of other kinds of network traffic with Tails.

Web Browser
-----------

Mike Perry's plans for torbrowser: per-tab SOCKS username, or
increment the username when the New Identity button is clicked, or
similar. But FF has a SOCKS username / password handling bug that
prevents us from having per-tab stream isolation, so this is likely to
happen as a Torbrowser patch FF: [[!tor_bug 3455]].
So on this front, we must first [[todo/replace_iceweasel_with_Torbrowser]].
[[!tag todo/wait]]

Destination address/port -based circuit isolation
-------------------------------------------------

Do we want to use `IsolateDestAddr` and/or `IsolateDestPort`?

Using these settings may help protecting against traffic correlation.
However:

* These settings are likely to have a performance impact on
  applications that connect to many remote hosts.
* These settings probably put more load on the network. On the other
  hand, the Tor people probably are happy with people using it given
  they have added the option in the first place. We will anyway ask
  them to review our proposed configuration with network load in mind
  before we ship it to the masses.

For performance reasons, we will start with *not* using
`IsolateDestAddr`/`IsolateDestPort` for iceweasel we ship: nowadays,
loading a mere web page often requires fetching resources from a dozen
or more remote sources. (Also, it looks like the use of
`IsolateDestAddr` in a modern web browser may create very uncommon
HTTP behaviour patterns, that could ease fingerprinting.)

Consider Pidgin with several accounts configured for different
identities. If you connect with all of the accounts at the same time,
they'll all get the same circuit, so the identities can be correlated.
While Tails does not formally support using multiple contextual
identities at the same time, Pidgin generally opens very few network
connections, so the performance impact of using `IsolateDestAddr`
should be small. Given how cheap it is, it looks like it is worth
having Pidgin use a (not necessarily dedicated) `SocksPort` that has
`IsolateDestAddr` and `IsolateDestPort` enabled.

For the same reason, we actually want to enable `IsolateDestAddr` and
`IsolateDestPort` for the `SocksPort` used by most applications,
unless we tell them otherwise.

The email client we ship is a special case: for the same
multiple-accounts reason as the IM client, we want `IsolateDestAddr`
for the MUA we ship. Adding `IsolateDestPort` to the mix would avoid
correlating unrelated email and IM accounts, *but* it breaks
POP-before-SMTP. Then, the MUA should use a `SocksPort` that has
`IsolateDestAddr` enabled, but `IsolateDestPort` disabled.

Conclusion
----------

This should be easy to implement, and enough to satisfy the "basic Tor
stream isolation" goal we have set for Tails 1.0:

* default system-wide `SocksPort` (9050): `IsolateDestAddr` and
  `IsolateDestPort` enabled
* dedicated `SocksPort` for the email client: `IsolateDestAddr`
  enabled
* dedicated `SocksPort` for Tails-specific applications:
  `IsolateDestAddr` and `IsolateDestPort` enabled
* dedicated `SocksPort` for web browser: no stream isolation options

Resources
=========

* [adrelanos' email on tails-dev](https://mailman.boum.org/pipermail/tails-dev/2012-August/001422.html)
* [aos design documentation](https://trac.torproject.org/projects/tor/wiki/doc/TorBOX/ApplicationWarningsAndNotes#Identitycorrelationthroughcircuitsharing)
  on this topic
