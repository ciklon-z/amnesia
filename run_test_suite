#!/bin/bash
# Note that we must use bash since we are gonna source files
# that have bashisms in them.

set -e

TARGET_DISPLAY=:8

start_xvfb() {
    Xvfb $TARGET_DISPLAY -screen 0 1024x768x16 >/dev/null 2>&1 &
    XVFB_PID=$!
    trap "kill -9 ${XVFB_PID}" EXIT
}

start_vnc_server() {
    VNC_SERVER_PORT="$(x11vnc -listen localhost -display ${TARGET_DISPLAY} \
                              -bg -nopw 2>&1 | \
	                          grep -m 1 "^PORT=[0-9]\+" | sed 's/^PORT=//')"
    echo "VNC server running on: localhost:${VNC_SERVER_PORT}"
}

start_vnc_viewer() {
    DISPLAY=":0" xtightvncviewer -viewonly localhost:${VNC_SERVER_PORT} 1>/dev/null 2>&1 &
}

# main script

start_xvfb

if [ "${1}" = "--view" ]; then
    VNC_VIEWER=yes
    VNC_SERVER=yes
    shift
elif [ "${1}" = "--vnc-server-only" ]; then
    VNC_VIEWER=
    VNC_SERVER="yes"
    shift
fi

if [ -n "${VNC_SERVER}" ]; then
    start_vnc_server
fi
if [ -n "${VNC_VIEWER}" ]; then
    start_vnc_viewer
fi

export SIKULI_HOME="/usr/share/java"
export DISPLAY=${TARGET_DISPLAY}
export ISO="$(readlink -f $1)"
cd features
. ./.rvmrc
cucumber cucumber/
